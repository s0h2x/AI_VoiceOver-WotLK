setfenv(1, VoiceOver)

local CLIENT_VERSION, _, _, INTERFACE_VERSION = GetBuildInfo()
INTERFACE_VERSION = INTERFACE_VERSION or 0 -- 1.12 doesn't return this

if not select then
    function _G.select(index, ...)
        local result = {}
        for i = index, arg.n do
            table.insert(result, arg[i])
        end
        return unpack(result)
    end
end

if not print then
    function _G.print(...)
        local text = ""
        for i = 1, arg.n do
            text = text .. (i > 1 and " " or "") .. tostring(arg[i])
        end
        DEFAULT_CHAT_FRAME:AddMessage(text)
    end
end

if not strsplit then
    function strsplit(delimiter, text)
        local result = {}
        local from = 1
        local delim_from, delim_to = string.find(text, delimiter, from)
        while delim_from do
            table.insert(result, string.sub(text, from, delim_from - 1))
            from = delim_to + 1
            delim_from, delim_to = string.find(text, delimiter, from)
        end
        table.insert(result, string.sub(text, from))
        return unpack(result)
    end
end

if not string.gmatch then
    string.gmatch = string.gfind
end

if not GetAddOnEnableState then
    function GetAddOnEnableState(character, addon)
        addon = addon or character -- GetAddOnEnableState([character], addon)
        local name, _, _, _, loadable, reason = _G.GetAddOnInfo(addon)
        if not name or not loadable and reason == "DISABLED" then
            return 0
        end
        return 2
    end

    function GetAddOnInfo(indexOrName)
        local name, title, notes, enabled, loadable, reason, security, newVersion = _G.GetAddOnInfo(indexOrName)
        return name, title, notes, loadable, reason, security, newVersion
    end
end

if not GetQuestID then
    local source, text
    local old_QUEST_DETAIL = Addon.QUEST_DETAIL
    local old_QUEST_PROGRESS = Addon.QUEST_PROGRESS
    local old_QUEST_COMPLETE = Addon.QUEST_COMPLETE
    function Addon:QUEST_DETAIL()   source = "accept"   text = GetQuestText()    old_QUEST_DETAIL(self) end
    function Addon:QUEST_PROGRESS() source = "progress" text = GetProgressText() old_QUEST_PROGRESS(self) end
    function Addon:QUEST_COMPLETE() source = "complete" text = GetRewardText()   old_QUEST_COMPLETE(self) end
    function GetQuestID()
        local npcName = Utils:GetNPCName()
        if Utils:IsNPCPlayer() then
            -- Can't do anything about quest sharing currently, because we need the original questgiver's name to obtain quest ID, and we need quest ID to obtain the questgiver's name
            return 0
        end

        return DataModules:GetQuestID(source, GetTitleText(), npcName, text) or 0
    end
end

if not StopSound then
	local CVMusicVolume_Default = GetCVar("Sound_MusicVolume")
	local CVEnableMusic_Default = GetCVar("Sound_EnableMusic")
	function StopSound(soundHandle)
		-- Sound_GameSystem_RestartSoundSystem() -- but you will get a micro freeze
		StopMusic(soundHandle)
		SetCVar("Sound_MusicVolume", CVMusicVolume_Default)
		SetCVar("Sound_EnableMusic", CVEnableMusic_Default)
	end
end
----------------------------------
-- Shared Extended Methods
-- Compatibility of some functions
----------------------------------
local Extension = {}
local TableMixins = {}
Extension["Frame"] = CreateFrame("Frame")
Extension["Button"] = CreateFrame("Button")
Extension["Texture"] = Extension.Frame:CreateTexture()
Extension["FontString"] = Extension.Frame:CreateFontString()
if WorldFrame then
    Extension["DressUpModel"] = CreateFrame("DressUpModel")
end
for frameType, frame in pairs(Extension) do
	frame:Hide(); TableMixins[frameType] = getmetatable(frame)
end

local FrameMixins = {}
function FrameMixins:SetShown(shown)
    if shown then
        self:Show()
    else
        self:Hide()
    end
end
function FrameMixins:SetResizeBounds(minWidth, minHeight, maxWidth, maxHeight)
    self:SetMinResize(minWidth, minHeight)
    if maxWidth and maxHeight then
        self:SetMaxResize(maxWidth, maxHeight)
    end
end

for _, metatable in pairs(TableMixins) do
    for name, func in pairs(FrameMixins) do
        metatable.__index[name] = func
    end
end

if Extension["DressUpModel"] then
    local ModelMixins = {}
    function ModelMixins:SetModelAnimation(animation, looping)
        if self.sequence then return end
		
        -- Refresh camera and animation in case the model wasn't loaded instantly
        self:SetCustomCamera(0)
		
        if not self.sequenceHooked then
            self:HookScript("OnAnimFinished", function(self)
                if not self.sequence then return end
                if self.sequenceLooping then
					self.sequenceTime = 0 -- Loop the animation when the timer has reached the animation duration
				end
				if Addon.db.char.IsPaused then
					self:StopModelAnimation()
				end
            end)
            
            self:HookScript("OnUpdate", function(self, elapsed)
                if not self.sequence then return end
				if not Addon.db.char.IsPaused then
					self:SetSequenceTime(self.sequence, self.sequenceTime)
					if not self.freezeSequence then
						self.sequenceTime = self.sequenceTime + elapsed * 1000
						-- self.animDuration = Utils:GetModelAnimationDuration(self:GetModelFileID(), animation)
					end
				else
					self:StopModelAnimation()
				end
            end)
            self.sequenceHooked = true
        end

        self.sequenceLooping = looping
        self.sequenceTime = 0
        self.sequence = 60
        self.freezeSequence = nil
    end
    function ModelMixins:StopModelAnimation(animation)
        if not self.PlayingSequence then return end
        -- allows conditional stopping on only a certain animation
        if animation and animation ~= self.sequence then return end
        self.sequence = nil
        self.freezeSequence = nil
    end
	function ModelMixins:SetCustomCamera(camera)
		self:SetCamera(camera)
	end

	if not WOW_PROJECT_ID and INTERFACE_VERSION < 70000 and INTERFACE_VERSION > 30300 then
		local modelToFileID = {
			["Original"] = {
				["interface/buttons/talktomequestion_white"]                = 130737,

				["character/bloodelf/female/bloodelffemale"]                = 116921,
				["character/bloodelf/male/bloodelfmale"]                    = 117170,
				["character/broken/female/brokenfemale"]                    = 117400,
				["character/broken/male/brokenmale"]                        = 117412,
				["character/draenei/female/draeneifemale"]                  = 117437,
				["character/draenei/male/draeneimale"]                      = 117721,
				["character/dwarf/female/dwarffemale"]                      = 118135,
				["character/dwarf/female/dwarffemale_hd"]                   = 950080,
				["character/dwarf/female/dwarffemale_npc"]                  = 950080,
				["character/dwarf/male/dwarfmale"]                          = 118355,
				["character/dwarf/male/dwarfmale_hd"]                       = 878772,
				["character/dwarf/male/dwarfmale_npc"]                      = 878772,
				["character/felorc/female/felorcfemale"]                    = 118652,
				["character/felorc/male/felorcmale"]                        = 118653,
				["character/felorc/male/felorcmaleaxe"]                     = 118654,
				["character/felorc/male/felorcmalesword"]                   = 118667,
				["character/foresttroll/male/foresttrollmale"]              = 118798,
				["character/gnome/female/gnomefemale"]                      = 119063,
				["character/gnome/female/gnomefemale_hd"]                   = 940356,
				["character/gnome/female/gnomefemale_npc"]                  = 940356,
				["character/gnome/male/gnomemale"]                          = 119159,
				["character/gnome/male/gnomemale_hd"]                       = 900914,
				["character/gnome/male/gnomemale_npc"]                      = 900914,
				["character/goblin/female/goblinfemale"]                    = 119369,
				["character/goblin/male/goblinmale"]                        = 119376,
				["character/goblinold/male/goblinoldmale"]                  = 119376,
				["character/human/female/humanfemale"]                      = 119563,
				["character/human/female/humanfemale_hd"]                   = 1000764,
				["character/human/female/humanfemale_npc"]                  = 1000764,
				["character/human/male/humanmale"]                          = 119940,
				["character/human/male/humanmale_cata"]                     = 119940,
				["character/human/male/humanmale_hd"]                       = 1011653,
				["character/human/male/humanmale_npc"]                      = 1011653,
				["character/icetroll/male/icetrollmale"]                    = 232863,
				["character/naga_/female/naga_female"]                      = 120263,
				["character/naga_/male/naga_male"]                          = 120294,
				["character/nightelf/female/nightelffemale"]                = 120590,
				["character/nightelf/female/nightelffemale_hd"]             = 921844,
				["character/nightelf/female/nightelffemale_npc"]            = 921844,
				["character/nightelf/male/nightelfmale"]                    = 120791,
				["character/nightelf/male/nightelfmale_hd"]                 = 974343,
				["character/nightelf/male/nightelfmale_npc"]                = 974343,
				["character/northrendskeleton/male/northrendskeletonmale"]  = 233367,
				["character/orc/female/orcfemale"]                          = 121087,
				["character/orc/female/orcfemale_npc"]                      = 121087,
				["character/orc/male/orcmale"]                              = 121287,
				["character/orc/male/orcmale_hd"]                           = 917116,
				["character/orc/male/orcmale_npc"]                          = 917116,
				["character/scourge/female/scourgefemale"]                  = 121608,
				["character/scourge/female/scourgefemale_hd"]               = 997378,
				["character/scourge/female/scourgefemale_npc"]              = 997378,
				["character/scourge/male/scourgemale"]                      = 121768,
				["character/scourge/male/scourgemale_hd"]                   = 959310,
				["character/scourge/male/scourgemale_npc"]                  = 959310,
				["character/skeleton/male/skeletonmale"]                    = 121942,
				["character/taunka/male/taunkamale"]                        = 233878,
				["character/tauren/female/taurenfemale"]                    = 121961,
				["character/tauren/female/taurenfemale_hd"]                 = 986648,
				["character/tauren/female/taurenfemale_npc"]                = 986648,
				["character/tauren/male/taurenmale"]                        = 122055,
				["character/tauren/male/taurenmale_hd"]                     = 968705,
				["character/tauren/male/taurenmale_npc"]                    = 968705,
				["character/troll/female/trollfemale"]                      = 122414,
				["character/troll/female/trollfemale_hd"]                   = 1018060,
				["character/troll/female/trollfemale_npc"]                  = 1018060,
				["character/troll/male/trollmale"]                          = 122560,
				["character/troll/male/trollmale_hd"]                       = 1022938,
				["character/troll/male/trollmale_npc"]                      = 1022938,
				["character/tuskarr/male/tuskarrmale"]                      = 122738,
				["character/vrykul/male/vrykulmale"]                        = 122815,
			},
			["HD"] = {
				["character/scourge/female/scourgefemale"]                  = 997378,
			},
		}
		local function CleanupModelName(model)
			return model:lower():gsub("\\", "/"):gsub("%.m2", ""):gsub("%.mdx", "")
		end
		function ModelMixins:GetModelFileID()
			local model = self:GetModel()
			if model and type(model) == "string" then
				model = CleanupModelName(model)
				local models = modelToFileID[Utils:GetCurrentModelSet()] or modelToFileID["Original"]
				return models[model] or modelToFileID["Original"][model]
			end
		end
	end
	
	for name, func in pairs(ModelMixins) do
		TableMixins.DressUpModel.__index[name] = func
	end
end

if not WOW_PROJECT_ID and INTERFACE_VERSION < 11300 then

    function Utils:GetNPCName()
        return UnitName("npc")
    end

    function Utils:GetNPCGUID()
        return nil
    end

    function Utils:IsNPCPlayer()
        return UnitIsPlayer("npc")
    end

elseif not WOW_PROJECT_ID and CLIENT_VERSION == "3.3.5" then

    GetGossipText = C_GossipInfo.GetText
    GetNumGossipActiveQuests = C_GossipInfo.GetNumActiveQuests
    GetNumGossipAvailableQuests = C_GossipInfo.GetNumAvailableQuests
	
    function Utils:GetQuestLogScrollOffset()
        return HybridScrollFrame_GetOffset(QuestLogScrollFrame);
    end

    function Utils:GetQuestLogTitleFrame(index)
        return _G["QuestLogScrollFrameButton" .. index]
    end
	
    function QuestOverlayUI:UpdateQuestTitle(questLogTitleFrame, playButton, normalText, questCheck)
        playButton:SetPoint("LEFT", questLogTitleFrame.normalText, "LEFT", 4, 0)
        questLogTitleFrame.normalText:SetText([[|TInterface\AddOns\AI_VoiceOver\Textures\spacer:1:24|t]] ..
            (questLogTitleFrame.normalText:GetText() or ""):trim())
        QuestLogTitleButton_Resize(questLogTitleFrame)
    end

    hooksecurefunc(Addon, "OnInitialize", function()
        QuestLogScrollFrame.update = QuestLog_Update
    end)
elseif WOW_PROJECT_ID == WOW_PROJECT_CLASSIC then

elseif WOW_PROJECT_ID == WOW_PROJECT_WRATH_CLASSIC then

    GetGossipText = C_GossipInfo.GetText
    GetNumGossipActiveQuests = C_GossipInfo.GetNumActiveQuests
    GetNumGossipAvailableQuests = C_GossipInfo.GetNumAvailableQuests

    function Utils:GetQuestLogScrollOffset()
        return HybridScrollFrame_GetOffset(QuestLogListScrollFrame)
    end

    function Utils:GetQuestLogTitleFrame(index)
        return _G["QuestLogListScrollFrameButton" .. index]
    end

    function QuestOverlayUI:UpdateQuestTitle(questLogTitleFrame, playButton, normalText, questCheck)
        playButton:SetPoint("LEFT", questLogTitleFrame.normalText, "LEFT", 4, 0)
        questLogTitleFrame.normalText:SetText([[|TInterface\AddOns\AI_VoiceOver\Textures\spacer:1:24|t]] ..
            (questLogTitleFrame.normalText:GetText() or ""):trim())
        QuestLogTitleButton_Resize(questLogTitleFrame)
    end

    hooksecurefunc(Addon, "OnInitialize", function()
        QuestLogListScrollFrame.update = QuestLog_Update
    end)

elseif WOW_PROJECT_ID == WOW_PROJECT_MAINLINE then

    function Utils:GetCurrentModelSet()
        return "HD"
    end

end
